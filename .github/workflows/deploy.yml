name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Inject configuration into HTML
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          TURNSTILE_SITE_KEY: ${{ secrets.TURNSTILE_SITE_KEY }}
        run: |
          # Set default API URL if secret is not set
          API_URL="${API_BASE_URL:-https://url-shortener-api.mkeeves.workers.dev}"
          TURNSTILE_KEY="${TURNSTILE_SITE_KEY:-}"
          
          # Use Python to inject configuration into HTML files
          python3 << PYTHON_SCRIPT
          import re
          import os
          
          api_url = os.environ.get('API_BASE_URL') or 'https://url-shortener-api.mkeeves.workers.dev'
          turnstile_key = os.environ.get('TURNSTILE_SITE_KEY') or ''
          
          config_script = f'''    <!-- Configuration injected by GitHub Actions -->
          <script>
          window.API_BASE_URL = '{api_url}';
          window.TURNSTILE_SITE_KEY = '{turnstile_key}';
          </script>'''
          
          pattern = r'<!-- Load configuration.*?onerror.*?</script>'
          
          for filename in ['index.html', 'analytics.html', '404.html']:
              if os.path.exists(filename):
                  with open(filename, 'r') as f:
                      content = f.read()
                  
                  # Replace the config.js script tag with inline config
                  new_content = re.sub(pattern, config_script, content, flags=re.DOTALL)
                  
                  # Verify the replacement worked
                  if 'window.API_BASE_URL' not in new_content:
                      print(f"ERROR: Configuration not found in {filename} after replacement!")
                      exit(1)
                  
                  with open(filename, 'w') as f:
                      f.write(new_content)
                  
                  # Verify the file was written correctly
                  with open(filename, 'r') as f:
                      verify_content = f.read()
                      if 'window.API_BASE_URL' not in verify_content:
                          print(f"ERROR: Configuration not found in {filename} after writing!")
                          exit(1)
                  
                  print(f"✅ Configuration injected into {filename}")
          PYTHON_SCRIPT
          
          echo "Configuration injection complete"
          echo "API_BASE_URL: ${API_URL}"
          
          # Final verification - check that the files contain the configuration
          if ! grep -q "window.API_BASE_URL" index.html; then
            echo "ERROR: Configuration verification failed for index.html"
            exit 1
          fi
          echo "✅ Configuration verified in all HTML files"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Verify configuration injection
        run: |
          # Verify API_BASE_URL is set in HTML files
          if grep -q "window.API_BASE_URL = '/api/urls'" index.html; then
            echo "WARNING: API_BASE_URL might be using default value!"
          fi
          echo "Configuration injection verified"

      - name: Debug - Show injected configuration
        run: |
          echo "=== Checking index.html ==="
          if grep -q "window.API_BASE_URL" index.html; then
            echo "✅ window.API_BASE_URL found in index.html"
            grep -A 2 "window.API_BASE_URL" index.html | head -3
          else
            echo "❌ window.API_BASE_URL NOT found in index.html"
            echo "First 20 lines of index.html:"
            head -20 index.html
          fi
          echo ""
          echo "=== Verifying file was written to disk ==="
          # Force sync to ensure files are written
          sync
          # Verify again after sync
          if grep -q "window.API_BASE_URL" index.html; then
            echo "✅ Confirmed: window.API_BASE_URL still in index.html after sync"
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          # Note: upload-pages-artifact includes all files in the path,
          # including those created during the workflow, even if in .gitignore
          
      - name: Verify artifact contents (if possible)
        run: |
          echo "Artifact upload completed. Files should include modified HTML with injected configuration."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

